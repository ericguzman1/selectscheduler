import React, { useState, useEffect, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  onAuthStateChanged, 
  signInWithEmailAndPassword, 
  createUserWithEmailAndPassword, 
  signOut 
} from 'firebase/auth';
import { 
  getFirestore, 
  collection, 
  addDoc, 
  onSnapshot, 
  query, 
  orderBy, 
  deleteDoc, 
  doc, 
  updateDoc,
  where,
  writeBatch,
  getDocs
} from 'firebase/firestore';

/**
 * ENVIRONMENT CONFIGURATION
 * Add these to Vercel Settings -> Environment Variables:
 * VITE_FIREBASE_API_KEY, VITE_FIREBASE_AUTH_DOMAIN, VITE_FIREBASE_PROJECT_ID,
 * VITE_FIREBASE_STORAGE_BUCKET, VITE_FIREBASE_MESSAGING_SENDER_ID, VITE_FIREBASE_APP_ID,
 * VITE_GEMINI_API_KEY
 */

const firebaseConfig = {
  apiKey: process.env.VITE_FIREBASE_API_KEY || "",
  authDomain: process.env.VITE_FIREBASE_AUTH_DOMAIN || "",
  projectId: process.env.VITE_FIREBASE_PROJECT_ID || "",
  storageBucket: process.env.VITE_FIREBASE_STORAGE_BUCKET || "",
  messagingSenderId: process.env.VITE_FIREBASE_MESSAGING_SENDER_ID || "",
  appId: process.env.VITE_FIREBASE_APP_ID || ""
};

const GEMINI_API_KEY = process.env.VITE_GEMINI_API_KEY || "";

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

export default function App() {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [currentPage, setCurrentPage] = useState('schedule');
  const [message, setMessage] = useState({ text: '', isError: false });
  const [aiEnabled, setAiEnabled] = useState(true);

  // Auth State Listener
  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, (user) => {
      setUser(user);
      setLoading(false);
    });
    return () => unsubscribe();
  }, []);

  const showMsg = (text, isError = false) => {
    setMessage({ text, isError });
    setTimeout(() => setMessage({ text: '', isError: false }), 5000);
  };

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-100 font-sans">
        <div className="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-[#424A9F]"></div>
      </div>
    );
  }

  if (!user) {
    return <AuthPage showMsg={showMsg} />;
  }

  return (
    <div className="min-h-screen bg-gray-100 font-sans text-gray-800 flex flex-col items-center p-4">
      {/* Header Container */}
      <div className="w-full max-w-6xl bg-white p-6 rounded-2xl shadow-xl mb-6">
        <div className="flex justify-between items-center mb-2">
          <h1 className="text-4xl font-extrabold text-[#424A9F]">Accenture Project Hub</h1>
          <div className="flex items-center space-x-4">
            <div className="flex items-center space-x-2">
              <span className="text-sm font-medium text-gray-600">AI Features</span>
              <label className="relative inline-flex items-center cursor-pointer">
                <input 
                  type="checkbox" 
                  className="sr-only peer" 
                  checked={aiEnabled} 
                  onChange={(e) => setAiEnabled(e.target.checked)} 
                />
                <div className="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[#A3E635]"></div>
              </label>
            </div>
            <button 
              onClick={() => signOut(auth)} 
              className="bg-gray-200 text-gray-700 font-semibold px-4 py-2 rounded-lg hover:bg-gray-300 transition"
            >
              Logout
            </button>
          </div>
        </div>
        <p className="text-center text-gray-600 mb-4 font-medium italic">Accenture High Performance. Delivered.</p>
        <div className="flex justify-center mb-4 space-x-2">
          <NavButton active={currentPage === 'schedule'} onClick={() => setCurrentPage('schedule')} label="Meetings & Events" />
          <NavButton active={currentPage === 'kanban'} onClick={() => setCurrentPage('kanban')} label="Task Board" />
          <NavButton active={currentPage === 'issues'} onClick={() => setCurrentPage('issues')} label="Tech Issues" />
        </div>
      </div>

      {/* Global Message Area */}
      {message.text && (
        <div className={`w-full max-w-6xl p-4 mb-4 rounded-lg shadow-md border-l-4 transition-all ${message.isError ? 'bg-red-100 border-red-500 text-red-700' : 'bg-blue-100 border-[#A3E635] text-blue-700'}`}>
          <p>{message.text}</p>
        </div>
      )}

      {/* Content Area */}
      <div className="w-full max-w-6xl flex-grow">
        {currentPage === 'schedule' && <SchedulePage user={user} showMsg={showMsg} aiEnabled={aiEnabled} />}
        {currentPage === 'kanban' && <KanbanPage user={user} showMsg={showMsg} aiEnabled={aiEnabled} />}
        {currentPage === 'issues' && <IssuesPage user={user} showMsg={showMsg} aiEnabled={aiEnabled} />}
      </div>
    </div>
  );
}

const NavButton = ({ active, onClick, label }) => (
  <button 
    onClick={onClick}
    className={`px-4 py-2 rounded-lg font-semibold transition-all duration-300 ${active ? 'bg-[#A3E635] text-gray-900 shadow-lg' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
  >
    {label}
  </button>
);

/* --- AUTH COMPONENT --- */
function AuthPage({ showMsg }) {
  const [isLogin, setIsLogin] = useState(true);
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');

  const handleSubmit = async (e) => {
    e.preventDefault();
    try {
      if (isLogin) {
        await signInWithEmailAndPassword(auth, email, password);
      } else {
        await createUserWithEmailAndPassword(auth, email, password);
      }
    } catch (err) {
      showMsg(err.message, true);
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-100 p-4 font-sans">
      <div className="w-full max-w-md bg-white p-8 rounded-2xl shadow-xl">
        <h1 className="text-3xl font-bold text-center text-[#424A9F] mb-6 tracking-tight">Accenture Project Hub</h1>
        <form onSubmit={handleSubmit} className="space-y-4">
          <input 
            type="email" placeholder="Corporate Email" required 
            className="w-full p-3 rounded-lg border-2 border-gray-300 focus:outline-none focus:ring-2 focus:ring-[#A3E635]"
            value={email} onChange={(e) => setEmail(e.target.value)}
          />
          <input 
            type="password" placeholder="Password" required 
            className="w-full p-3 rounded-lg border-2 border-gray-300 focus:outline-none focus:ring-2 focus:ring-[#A3E635]"
            value={password} onChange={(e) => setPassword(e.target.value)}
          />
          <button type="submit" className={`w-full text-white font-bold py-3 rounded-lg transition-colors ${isLogin ? 'bg-[#424A9F] hover:bg-[#343D84]' : 'bg-[#A3E635] text-gray-900 hover:bg-[#8CD02F]'}`}>
            {isLogin ? 'Login' : 'Register'}
          </button>
        </form>
        <p className="text-center text-sm text-gray-500 mt-6">
          {isLogin ? "Don't have an account? " : "Already have an account? "}
          <button onClick={() => setIsLogin(!isLogin)} className="font-semibold text-[#424A9F] hover:underline">
            {isLogin ? 'Register here' : 'Login here'}
          </button>
        </p>
      </div>
    </div>
  );
}

/* --- SCHEDULE PAGE --- */
function SchedulePage({ user, showMsg, aiEnabled }) {
  const [events, setEvents] = useState([]);
  const [isAiLoading, setIsAiLoading] = useState(false);
  const [summary, setSummary] = useState('');
  const formRef = useRef();

  useEffect(() => {
    const q = query(collection(db, 'shared_events'), orderBy('startDate', 'asc'));
    const unsub = onSnapshot(q, (snap) => {
      setEvents(snap.docs.map(d => ({ id: d.id, ...d.data() })));
    });
    return () => unsub();
  }, []);

  const handleAddEvent = async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());
    try {
      await addDoc(collection(db, 'shared_events'), { 
        ...data, 
        createdBy: user.uid,
        timestamp: new Date().toISOString() 
      });
      e.target.reset();
      showMsg('Event added successfully!');
    } catch (err) { showMsg(err.message, true); }
  };

  const handleAiExtract = async () => {
    const text = formRef.current.querySelector('#pdfText').value;
    if (!text.trim() || !aiEnabled) return;
    setIsAiLoading(true);
    const prompt = `From the provided BEO text, output only valid events as a JSON object with keys: eventName, eventPoc, startDate (YYYY-MM-DD), endDate (YYYY-MM-DD), location, eventLocation. Text: ${text}`;
    
    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } })
      });
      const result = await response.json();
      const extracted = JSON.parse(result.candidates[0].content.parts[0].text);
      
      const form = formRef.current.querySelector('#scheduleForm');
      Object.keys(extracted).forEach(key => {
        if (form.elements[key]) form.elements[key].value = extracted[key];
      });
      showMsg('Data extracted successfully via AI!');
    } catch (err) { showMsg('AI Extraction failed.', true); }
    setIsAiLoading(false);
  };

  return (
    <div className="bg-white p-6 rounded-2xl shadow-xl grid md:grid-cols-2 gap-8" ref={formRef}>
      <div className="space-y-4">
        <h2 className="text-2xl font-bold text-[#424A9F]">Add Event & AI Reader</h2>
        <div className="p-4 bg-gray-50 rounded-xl shadow-inner border border-gray-200">
          <textarea id="pdfText" className="w-full h-32 p-2 rounded-lg border-2 border-gray-300 resize-none outline-none" placeholder="Paste BEO text here..."></textarea>
          <button onClick={handleAiExtract} disabled={isAiLoading} className="mt-2 w-full bg-[#A3E635] text-gray-900 font-bold py-2 rounded-lg hover:bg-[#8CD02F] transition">
            {isAiLoading ? 'AI is Thinking...' : 'Extract Data with AI'}
          </button>
        </div>
        <form id="scheduleForm" onSubmit={handleAddEvent} className="space-y-3">
          <input name="eventName" placeholder="Event Name*" required className="w-full p-2 border rounded-lg" />
          <input name="eventPoc" placeholder="Event POC*" required className="w-full p-2 border rounded-lg" />
          <div className="grid grid-cols-2 gap-2">
            <input name="startDate" type="date" required className="p-2 border rounded-lg" />
            <input name="endDate" type="date" required className="p-2 border rounded-lg" />
          </div>
          <input name="location" placeholder="Location" defaultValue="NYIH" className="w-full p-2 border rounded-lg" />
          <input name="eventLocation" placeholder="Event Room/Location" className="w-full p-2 border rounded-lg" />
          <button type="submit" className="w-full bg-[#424A9F] text-white font-bold py-3 rounded-lg hover:bg-[#343D84]">Save Event</button>
        </form>
      </div>
      <div>
        <div className="flex justify-between items-center mb-4">
          <h2 className="text-2xl font-bold text-[#424A9F]">Team Schedule</h2>
          <button onClick={() => showMsg('Syncing...')} className="text-gray-500 hover:text-[#424A9F] transition"><Zap size={20}/></button>
        </div>
        <div className="space-y-3 max-h-[60vh] overflow-y-auto p-2">
          {events.map(ev => (
            <div key={ev.id} className="bg-gray-50 p-4 rounded-xl shadow-sm border-l-4 border-[#424A9F] flex justify-between items-center">
              <div>
                <p className="font-bold">{ev.eventName}</p>
                <p className="text-xs text-gray-500">{ev.startDate} | {ev.eventPoc}</p>
              </div>
              <button onClick={() => deleteDoc(doc(db, 'shared_events', ev.id))} className="text-gray-400 hover:text-red-500 transition"><Trash2 size={18}/></button>
            </div>
          ))}
        </div>
      </div>
    </div>
  );
}

/* --- KANBAN PAGE --- */
function KanbanPage({ user, showMsg }) {
  const [tasks, setTasks] = useState([]);

  useEffect(() => {
    const q = query(collection(db, 'shared_tasks'));
    const unsub = onSnapshot(q, (snap) => {
      setTasks(snap.docs.map(d => ({ id: d.id, ...d.data() })));
    });
    return () => unsub();
  }, []);

  const handleAddTask = async (e) => {
    e.preventDefault();
    const input = e.target.taskName;
    if (!input.value.trim()) return;
    try {
      await addDoc(collection(db, 'shared_tasks'), { 
        text: input.value, 
        status: 'todo', 
        createdBy: user.uid,
        timestamp: new Date().toISOString() 
      });
      input.value = '';
      showMsg('Task created!');
    } catch (err) { showMsg(err.message, true); }
  };

  const updateStatus = async (id, status) => {
    await updateDoc(doc(db, 'shared_tasks', id), { status });
  };

  const Column = ({ status, title }) => (
    <div className="bg-gray-100 p-4 rounded-xl flex flex-col min-h-[400px]">
      <h3 className="font-bold text-[#424A9F] mb-4 text-center border-b pb-2 uppercase text-sm tracking-widest">{title}</h3>
      <div className="space-y-3 flex-grow">
        {tasks.filter(t => t.status === status).map(task => (
          <div key={task.id} className="bg-white p-3 rounded-lg shadow border-l-4 border-purple-400 group">
            <p className="text-sm font-semibold">{task.text}</p>
            <div className="mt-4 flex justify-between items-center opacity-0 group-hover:opacity-100 transition">
              <div className="flex space-x-1">
                {status !== 'todo' && <button onClick={() => updateStatus(task.id, 'todo')} className="p-1 bg-gray-100 rounded hover:bg-gray-200"><ChevronLeft size={14}/></button>}
                {status !== 'complete' && <button onClick={() => updateStatus(task.id, status === 'todo' ? 'doing' : 'complete')} className="p-1 bg-gray-100 rounded hover:bg-gray-200"><ChevronRight size={14}/></button>}
              </div>
              <button onClick={() => deleteDoc(doc(db, 'shared_tasks', task.id))} className="text-red-300 hover:text-red-500"><Trash2 size={14}/></button>
            </div>
          </div>
        ))}
      </div>
    </div>
  );

  return (
    <div className="bg-white p-6 rounded-2xl shadow-xl">
      <form onSubmit={handleAddTask} className="flex gap-2 mb-6 max-w-xl mx-auto">
        <input name="taskName" placeholder="New high-performance task..." className="flex-grow p-2 border-2 rounded-lg outline-none focus:ring-2 focus:ring-[#A3E635]" />
        <button type="submit" className="bg-[#424A9F] text-white px-6 py-2 rounded-lg font-bold">Add</button>
      </form>
      <div className="grid md:grid-cols-3 gap-6">
        <Column status="todo" title="Needs to be Done" />
        <Column status="doing" title="In Progress" />
        <Column status="complete" title="Completed" />
      </div>
    </div>
  );
}

/* --- ISSUES PAGE --- */
function IssuesPage({ user, showMsg }) {
  const [issues, setIssues] = useState([]);

  useEffect(() => {
    const q = query(collection(db, 'shared_issues'), orderBy('timestamp', 'desc'));
    const unsub = onSnapshot(q, (snap) => {
      setIssues(snap.docs.map(d => ({ id: d.id, ...d.data() })));
    });
    return () => unsub();
  }, []);

  const handleLogIssue = async (e) => {
    e.preventDefault();
    const fd = new FormData(e.target);
    const data = Object.fromEntries(fd.entries());
    try {
      await addDoc(collection(db, 'shared_issues'), { 
        ...data, 
        timestamp: new Date().toISOString(),
        status: 'Open'
      });
      e.target.reset();
      showMsg('Issue logged correctly.');
    } catch (err) { showMsg(err.message, true); }
  };

  return (
    <div className="bg-white p-6 rounded-2xl shadow-xl grid md:grid-cols-2 gap-8">
      <div>
        <h2 className="text-2xl font-bold text-red-600 mb-4 flex items-center"><AlertCircle className="mr-2"/> Log Tech Blocker</h2>
        <form onSubmit={handleLogIssue} className="space-y-4">
          <input name="issueTitle" placeholder="Issue Summary*" required className="w-full p-2 border rounded-lg" />
          <textarea name="issueDescription" placeholder="Provide technical details..." required rows="4" className="w-full p-2 border rounded-lg"></textarea>
          <select name="urgency" className="w-full p-2 border rounded-lg bg-white">
            <option>Low</option><option>Medium</option><option>High</option><option>Urgent</option>
          </select>
          <button type="submit" className="w-full bg-red-600 text-white font-bold py-2 rounded-lg hover:bg-red-700 transition">Report Incident</button>
        </form>
      </div>
      <div>
        <h2 className="text-2xl font-bold text-gray-700 mb-4 tracking-tight">Environment Status</h2>
        <div className="space-y-4">
          {issues.length > 0 ? issues.map(issue => (
            <div key={issue.id} className={`p-4 rounded-xl shadow-sm border-l-4 ${issue.urgency === 'Urgent' ? 'border-red-600 bg-red-50' : 'border-yellow-500 bg-white'}`}>
              <div className="flex justify-between items-start">
                <h3 className="font-bold">{issue.issueTitle}</h3>
                <button onClick={() => deleteDoc(doc(db, 'shared_issues', issue.id))} className="text-gray-300 hover:text-red-500 transition"><Trash2 size={16}/></button>
              </div>
              <p className="text-sm text-gray-600 mt-1">{issue.issueDescription}</p>
              <div className="mt-3 flex items-center justify-between text-[10px] font-black uppercase tracking-tighter">
                <span className="bg-gray-200 px-2 py-0.5 rounded-full">{issue.urgency}</span>
                <button onClick={() => showMsg('Exporting to ServiceNow placeholder')} className="text-[#424A9F] hover:underline flex items-center italic">ServiceNow Export <ArrowRight size={10} className="ml-1"/></button>
              </div>
            </div>
          )) : <p className="text-center text-gray-400 py-10 italic">No active tech blockers.</p>}
        </div>
      </div>
    </div>
  );
}
