<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accenture Project Hub</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Base styles and cross-browser compatibility fixes */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: #f7fafc; 
            color: #1a202c;
            -webkit-text-size-adjust: 100%;
            text-size-adjust: 100%;
        }
        .non-selectable {
            -webkit-user-select: none; -moz-user-select: none; user-select: none;
        }
        /* Custom scrollbar styling for WebKit browsers */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #a3a3a3; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        /* Custom colors matching your theme */
        .bg-\[\#424A9F\] { background-color: #424A9F; }
        .text-\[\#424A9F\] { color: #424A9F; }
        .hover\:bg-\[\#343D84\]:hover { background-color: #343D84; }
        .bg-\[\#A3E635\] { background-color: #A3E635; }
        .hover\:bg-\[\#8CD02F\]:hover { background-color: #8CD02F; }
        .border-\[\#424A9F\] { border-color: #424A9F; }
        .border-purple-500 { border-color: #9f7aea; }
        .border-red-600 { border-color: #e53e3e; }
        .border-yellow-500 { border-color: #f59e0b; }
        
        /* Kanban board styles */
        .kanban-column { min-height: 400px; max-height: 70vh; overflow-y: auto; }
        .kanban-card { cursor: grab; }
        .kanban-card:active { cursor: grabbing; opacity: 0.8; transform: scale(1.05); }
        .dragging { opacity: 0.5; }
        .drag-over { border: 2px dashed #a3e635; }

        /* Hide spinner arrows on number inputs */
        input[type='number']::-webkit-inner-spin-button, 
        input[type='number']::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type='number'] { -moz-appearance: textfield; }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Auth Container -->
    <div id="auth-container" class="min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-white p-8 rounded-2xl shadow-xl">
            <h1 class="text-3xl font-bold text-center text-[#424A9F] mb-4">Accenture Project Hub</h1>
            <form id="login-form" class="space-y-4">
                <input type="email" id="login-email" placeholder="Email" required class="w-full p-3 rounded-lg border-2 border-gray-300 focus:outline-none focus:ring-2 focus:ring-[#A3E635]">
                <input type="password" id="login-password" placeholder="Password" required class="w-full p-3 rounded-lg border-2 border-gray-300 focus:outline-none focus:ring-2 focus:ring-[#A3E635]">
                <button type="submit" class="w-full bg-[#424A9F] text-white font-bold py-3 rounded-lg hover:bg-[#343D84]">Login</button>
            </form>
             <p class="text-center text-sm text-gray-500 mt-4">
                Don't have an account? <a href="#" id="show-register" class="font-semibold text-[#424A9F] hover:underline">Register here</a>
            </p>
            <form id="register-form" class="space-y-4 hidden mt-4">
                <input type="email" id="register-email" placeholder="Email" required class="w-full p-3 rounded-lg border-2 border-gray-300 focus:outline-none focus:ring-2 focus:ring-[#A3E635]">
                <input type="password" id="register-password" placeholder="Password" required class="w-full p-3 rounded-lg border-2 border-gray-300 focus:outline-none focus:ring-2 focus:ring-[#A3E635]">
                <button type="submit" class="w-full bg-[#A3E635] text-gray-900 font-bold py-3 rounded-lg hover:bg-[#8CD02F]">Register</button>
                 <p class="text-center text-sm text-gray-500 mt-4">
                    Already have an account? <a href="#" id="show-login" class="font-semibold text-[#424A9F] hover:underline">Login here</a>
                </p>
            </form>
        </div>
    </div>

    <!-- Main App Container (Initially Hidden) -->
    <div id="app-container" class="min-h-screen p-4 flex-col items-center hidden">
        <div class="w-full max-w-6xl bg-white p-6 rounded-2xl shadow-xl mb-6">
            <div class="flex justify-between items-center mb-2">
                 <h1 class="text-4xl font-extrabold text-[#424A9F]">Accenture Project Hub</h1>
                 <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <span class="text-sm font-medium text-gray-600">AI Features</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="ai-toggle" class="sr-only peer" checked>
                            <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[#A3E635]"></div>
                        </label>
                    </div>
                    <button id="logout-btn" class="bg-gray-200 text-gray-700 font-semibold px-4 py-2 rounded-lg hover:bg-gray-300">Logout</button>
                 </div>
            </div>
            <p class="text-center text-gray-600 mb-4">Welcome to your team's central command center.</p>
            <div class="flex justify-center mb-4 space-x-2">
                <button data-page="schedule" class="nav-button px-4 py-2 rounded-lg font-semibold bg-[#A3E635] text-gray-900 shadow-lg">Meetings & Events</button>
                <button data-page="kanban" class="nav-button px-4 py-2 rounded-lg font-semibold bg-gray-200 text-gray-700 hover:bg-gray-300">Task Board</button>
                <button data-page="issues" class="nav-button px-4 py-2 rounded-lg font-semibold bg-gray-200 text-gray-700 hover:bg-gray-300">Tech Issues</button>
            </div>
        </div>
        <div id="message-area" class="w-full max-w-6xl hidden bg-blue-100 border-l-4 border-[#A3E635] text-blue-700 p-4 mb-4 rounded-lg shadow-md" role="alert">
            <p id="message-text"></p>
        </div>
        <div id="content-area" class="w-full max-w-6xl flex-grow"></div>
    </div>
    
    <div id="modal-container"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, collection, onSnapshot, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCBuOzD3V96thT2TIiC3n8DdvpfChGYjEo",
            authDomain: "schedule-fef69.firebaseapp.com",
            projectId: "schedule-fef69",
            storageBucket: "schedule-fef69.appspot.com",
            messagingSenderId: "565438351947",
            appId: "1:565438351947:web:b787c417351d16a19cdbce"
        };
        
        // =================================================================================
        // ======================== IMPORTANT: PASTE YOUR API KEY HERE =======================
        // =================================================================================
        //
        // You MUST replace the text "PASTE_YOUR_GEMINI_API_KEY_IN_THESE_QUOTES" with your actual Google Gemini API key.
        // This is the ONLY line you need to edit.
        //
        const GEMINI_API_KEY = "AIzaSyCeWmYZNfeeuxaTBqryAGu92_ui7EBLcpM";
        //
        // =================================================================================


        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let userId = null;
        let currentPage = 'schedule';
        let currentEvents = [], currentTasks = [], currentIssues = [];
        let unsubscribeEvents, unsubscribeTasks, unsubscribeIssues;
        let aiFeaturesEnabled = true;
        // Track editing state
        let editingEventId = null;
        let editingTaskId = null;

        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        
        function showMessage(msg, isError = false) {
            const msgArea = document.getElementById('message-area');
            const msgText = document.getElementById('message-text');
            if (!msgArea || !msgText) return;
            msgText.textContent = msg;
            msgArea.classList.remove('hidden', 'bg-blue-100', 'border-[#A3E635]', 'text-blue-700', 'bg-red-100', 'border-red-500', 'text-red-700');
            if (isError) {
                msgArea.classList.add('bg-red-100', 'border-red-500', 'text-red-700');
            } else {
                msgArea.classList.add('bg-blue-100', 'border-[#A3E635]', 'text-blue-700');
            }
            setTimeout(() => {
                msgArea.classList.add('hidden');
            }, 5000);
        }

        function getIcon(name, classes = 'w-4 h-4 inline-block mr-2') {
            const iconMap = {
                calendar: 'fa-calendar-alt',
                zap: 'fa-bolt',
                trash: 'fa-trash-alt',
                book: 'fa-book-open',
                export: 'fa-external-link-alt',
                refresh: 'fa-sync-alt',
                xcircle: 'fa-times-circle',
                search: 'fa-search',
                chevronLeft: 'fa-chevron-left',
                chevronRight: 'fa-chevron-right',
                plus: 'fa-plus',
                edit: 'fa-edit' // Added edit icon
            };
            return `<i class="fas ${iconMap[name] || ''} ${classes}"></i>`;
        }
        
        async function fetchGemini(prompt, isJson = false) {
             if (!aiFeaturesEnabled) {
                showMessage("AI features are currently disabled. You can enable them in the header.", true);
                return isJson ? {} : "AI Disabled.";
            }
            if (!GEMINI_API_KEY || GEMINI_API_KEY === "PASTE_YOUR_GEMINI_API_KEY_IN_THESE_QUOTES") {
                showMessage("AI Error: Gemini API Key is missing. Please follow the instructions in the code to add it.", true);
                return isJson ? {} : "AI Key Missing.";
            }

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
            };
            if(isJson) {
                payload.generationConfig = { responseMimeType: "application/json" };
            }

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                
                if (!response.ok || !result.candidates) {
                    throw new Error(result.error?.message || `HTTP ${response.status} failed.`);
                }
                const generatedText = result.candidates[0]?.content?.parts[0]?.text;
                return isJson ? JSON.parse(generatedText || '{}') : generatedText;
            } catch (error) {
                console.error("Gemini API Error:", error);
                showMessage(`AI Error: ${error.message}`, true);
                return isJson ? {} : `AI Error: ${error.message}`;
            }
        }
        
        // --- AUTHENTICATION ---
        
        function setupAuthListeners() {
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('register-form').addEventListener('submit', handleRegister);
            document.getElementById('show-register').addEventListener('click', toggleAuthForms);
            document.getElementById('show-login').addEventListener('click', toggleAuthForms);
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
        }

        function toggleAuthForms(e) {
            e.preventDefault();
            document.getElementById('login-form').classList.toggle('hidden');
            document.getElementById('register-form').classList.toggle('hidden');
        }
        
        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                showMessage(error.message, true);
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            try {
                await createUserWithEmailAndPassword(auth, email, password);
            } catch (error) {
                showMessage(error.message, true);
            }
        }

        async function handleLogout() {
            await signOut(auth);
        }
        
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                authContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                appContainer.classList.add('flex'); // Make it a flex container
                setupAppListeners();
                setupDataListeners();
                handleNavigate('schedule');
            } else {
                userId = null;
                authContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
                appContainer.classList.remove('flex');
                if (unsubscribeEvents) unsubscribeEvents();
                if (unsubscribeTasks) unsubscribeTasks();
                if (unsubscribeIssues) unsubscribeIssues();
            }
        });

        // --- APP NAVIGATION & RENDERING ---
        
        function setupAppListeners() {
            document.querySelectorAll('.nav-button').forEach(btn => {
                btn.addEventListener('click', () => handleNavigate(btn.dataset.page));
            });
            document.getElementById('ai-toggle').addEventListener('change', (e) => {
                aiFeaturesEnabled = e.target.checked;
                showMessage(`AI features have been ${aiFeaturesEnabled ? 'enabled' : 'disabled'}.`);
            });
        }

        function handleNavigate(pageName) {
            currentPage = pageName;
            // Clear editing states when navigating
            editingEventId = null;
            editingTaskId = null;

            document.querySelectorAll('.nav-button').forEach(btn => {
                const isActive = btn.dataset.page === pageName;
                btn.classList.toggle('bg-[#A3E635]', isActive);
                btn.classList.toggle('text-gray-900', isActive);
                btn.classList.toggle('shadow-lg', isActive);
                btn.classList.toggle('bg-gray-200', !isActive);
                btn.classList.toggle('text-gray-700', !isActive);
            });
            renderPage();
        }

        function renderPage() {
            const contentArea = document.getElementById('content-area');
            if (!contentArea) return;
            switch (currentPage) {
                case 'schedule': contentArea.innerHTML = renderSchedulePage(); attachScheduleListeners(); break;
                case 'kanban': contentArea.innerHTML = renderKanbanPage(); attachKanbanListeners(); break;
                case 'issues': contentArea.innerHTML = renderIssuesPage(); attachIssuesListeners(); break;
            }
        }
        
        // --- DATA LISTENERS (FIRESTORE) ---
        function setupDataListeners() {
            if (!userId) return;
            if (unsubscribeEvents) unsubscribeEvents();
            if (unsubscribeTasks) unsubscribeTasks();
            if (unsubscribeIssues) unsubscribeIssues();

            const eventsRef = collection(db, 'shared_events');
            unsubscribeEvents = onSnapshot(eventsRef, (snapshot) => {
                currentEvents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
                if (currentPage === 'schedule') renderPage();
            });

            const tasksRef = collection(db, 'shared_tasks');
            unsubscribeTasks = onSnapshot(tasksRef, (snapshot) => {
                currentTasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (currentPage === 'kanban') renderPage();
            });

            const issuesRef = collection(db, 'shared_issues');
            unsubscribeIssues = onSnapshot(issuesRef, (snapshot) => {
                currentIssues = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                if (currentPage === 'issues') renderPage();
            });
        }
        
        // --- SCHEDULE PAGE ---
        function renderSchedulePage() {
            const resourceOptions = ["Surface Hubs", "Proto", "Spot", "Hypervsn", "GenAI", "Vestaboard", "Loaner Laptop", "Clicker", "Teams Call", "Vu AI", "Other"];
            const resourceCheckboxes = resourceOptions.map(r => `
                <label class="flex items-center space-x-2 text-sm text-gray-700">
                    <input type="checkbox" name="demo" value="${r}" class="text-[#424A9F] focus:ring-[#A3E635] rounded">
                    <span>${r}</span>
                </label>`).join('');
            
            const classificationOptions = ["Client Visit", "Internal", "Community", "Training", "Client Preparation", "Workspace"];
            const sessionTypeOptions = ["Conference/ Boardroom", "Clusters/Pods", "Auditorium/Theatre/Chairs Only", "U-Shaped", "Other", "Partition"];

            return `
                <div class="bg-white p-6 rounded-2xl shadow-xl grid md:grid-cols-2 gap-8">
                    <!-- Left Side: Form & AI -->
                    <div class="space-y-4">
                        <h2 class="text-2xl font-bold text-[#424A9F]">${editingEventId ? 'Edit Event' : 'Add Event'} & AI Extraction</h2>
                        
                        <div class="p-4 bg-gray-50 rounded-xl shadow-inner border border-gray-200">
                            <label class="block text-sm font-medium mb-1 text-gray-700">Paste BEO Text for AI Extraction:</label>
                            <textarea id="pdf-text-input" class="w-full h-32 p-2 rounded-lg border-2 border-gray-300 bg-white text-gray-900 resize-none focus:outline-none focus:ring-2 focus:ring-[#A3E635]" placeholder="Paste your BEO text here..."></textarea>
                            <button id="analyze-pdf-btn" class="mt-2 w-full bg-[#A3E635] text-gray-900 font-bold py-2 px-4 rounded-lg hover:bg-[#8CD02F] transition-colors duration-300 flex items-center justify-center">
                                ${getIcon('zap')} <span id="analyze-btn-text">Extract Data with AI</span>
                            </button>
                        </div>

                        <form id="event-form" class="space-y-4 p-4 border border-gray-200 rounded-xl">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input name="eventName" type="text" placeholder="Event Name*" required class="w-full p-2 rounded-lg border-2 border-gray-300">
                                <input name="eventPoc" type="text" placeholder="Event POC*" required class="w-full p-2 rounded-lg border-2 border-gray-300">
                            </div>
                             <input name="selectPoc" type="text" placeholder="SELECT POC" class="w-full p-2 rounded-lg border-2 border-gray-300">
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label class="text-xs text-gray-500">Start Date*</label><input name="startDate" type="date" required class="w-full p-2 rounded-lg border-2 border-gray-300"></div>
                                <div><label class="text-xs text-gray-500">End Date*</label><input name="endDate" type="date" required class="w-full p-2 rounded-lg border-2 border-gray-300"></div>
                                <input name="location" type="text" placeholder="Location (e.g., NYIH)" value="NYIH" class="w-full p-2 rounded-lg border-2 border-gray-300">
                                <input name="eventLocation" type="text" placeholder="Event Location" class="w-full p-2 rounded-lg border-2 border-gray-300">
                                <select name="classification" class="w-full p-2 rounded-lg border-2 border-gray-300 bg-white"><option value="">Classification</option>${classificationOptions.map(o => `<option value="${o}">${o}</option>`).join('')}</select>
                                <select name="sessionType" class="w-full p-2 rounded-lg border-2 border-gray-300 bg-white"><option value="">Session Type</option>${sessionTypeOptions.map(o => `<option value="${o}">${o}</option>`).join('')}</select>
                            </div>
                            <input name="attendees" type="text" placeholder="Attendees" class="w-full p-2 rounded-lg border-2 border-gray-300">
                            <details class="bg-gray-100 p-3 rounded-lg">
                                <summary class="font-medium text-sm text-gray-700 cursor-pointer">Demo Resources</summary>
                                <div class="grid grid-cols-2 gap-2 mt-2 pt-2 border-t">
                                    ${resourceCheckboxes}
                                </div>
                            </details>
                            <textarea name="selectResources" placeholder="SELECT Resources" rows="2" class="w-full p-2 rounded-lg border-2 border-gray-300"></textarea>
                            <textarea name="additionalNotes" placeholder="Additional Notes (used for AI Summary)" rows="3" class="w-full p-2 rounded-lg border-2 border-gray-300"></textarea>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input name="sessionDays" type="text" placeholder="Session Days" class="w-full p-2 rounded-lg border-2 border-gray-300">
                                <input name="sessionSupportDuration" type="text" placeholder="SELECT Support Duration" class="w-full p-2 rounded-lg border-2 border-gray-300">
                            </div>
                            <button type="submit" class="w-full bg-[#424A9F] text-white font-bold py-3 rounded-lg hover:bg-[#343D84] transition-colors duration-300">
                                ${getIcon('calendar')} ${editingEventId ? 'Update Event' : 'Add Event'}
                            </button>
                            ${editingEventId ? `<button type="button" id="cancel-edit-event-btn" class="w-full bg-gray-300 text-gray-800 font-bold py-2 rounded-lg hover:bg-gray-400">Cancel Edit</button>` : ''}
                        </form>
                    </div>

                    <!-- Right Side: Events List -->
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <h2 class="text-2xl font-bold text-[#424A9F]">Upcoming Events (${currentEvents.length})</h2>
                            <button id="generate-summary-btn" class="bg-[#A3E635] text-gray-900 font-bold py-2 px-3 rounded-lg hover:bg-[#8CD02F] text-sm flex items-center justify-center">
                                ${getIcon('zap', 'w-4 h-4 mr-1')} <span id="summary-btn-text">AI Summary</span>
                            </button>
                        </div>
                        <div id="summary-output" class="hidden bg-gray-100 p-4 rounded-lg shadow-inner whitespace-pre-wrap font-mono text-sm"></div>
                        <div id="event-list" class="space-y-3 max-h-[60vh] overflow-y-auto p-2 border rounded-xl bg-gray-50">
                            ${currentEvents.length > 0 ? currentEvents.map(event => `
                                <div class="bg-white p-4 rounded-xl shadow-md flex justify-between items-start border-l-4 border-[#424A9F]">
                                    <div>
                                        <h3 class="text-lg font-semibold">${event.eventName}</h3>
                                        <p class="text-sm text-gray-600"><strong>Date:</strong> ${event.startDate} to ${event.endDate}</p>
                                        <p class="text-sm text-gray-600"><strong>POC:</strong> ${event.eventPoc}</p>
                                        <p class="text-sm text-gray-600"><strong>Location:</strong> ${event.eventLocation}</p>
                                    </div>
                                    <div class="flex flex-col gap-2">
                                        <button data-event-id="${event.id}" class="export-btn bg-gray-200 text-gray-700 px-3 py-1 rounded-lg text-xs font-bold hover:bg-gray-300 flex items-center">${getIcon('export', 'w-3 h-3 mr-1')} Export</button>
                                        <div class="flex gap-1">
                                            <button data-id="${event.id}" class="edit-event-btn bg-blue-500 text-white px-3 py-1 rounded-lg text-xs font-bold hover:bg-blue-600 flex items-center flex-1 justify-center">${getIcon('edit', 'w-3 h-3 mr-1')} Edit</button>
                                            <button data-id="${event.id}" class="delete-event-btn bg-red-500 text-white px-3 py-1 rounded-lg text-xs font-bold hover:bg-red-600 flex items-center flex-1 justify-center">${getIcon('trash', 'w-3 h-3 mr-1')} Del</button>
                                        </div>
                                    </div>
                                </div>
                            `).join('') : '<p class="text-center text-gray-500 p-8">No upcoming events.</p>'}
                        </div>
                    </div>
                </div>
            `;
        }

        function attachScheduleListeners() {
            document.getElementById('event-form').addEventListener('submit', handleEventSubmit);
            document.getElementById('analyze-pdf-btn').addEventListener('click', handleAnalyzePDF);
            document.getElementById('generate-summary-btn').addEventListener('click', handleGenerateEventSummary);
            document.querySelectorAll('.delete-event-btn').forEach(btn => btn.addEventListener('click', (e) => handleDelete('events', e.currentTarget.dataset.id)));
            document.querySelectorAll('.export-btn').forEach(btn => btn.addEventListener('click', (e) => handleExtractForServiceNow(e.currentTarget.dataset.eventId)));
            document.querySelectorAll('.edit-event-btn').forEach(btn => btn.addEventListener('click', (e) => handleEditEvent(e.currentTarget.dataset.id)));
            
            const cancelBtn = document.getElementById('cancel-edit-event-btn');
            if(cancelBtn) cancelBtn.addEventListener('click', () => {
                editingEventId = null;
                renderPage();
            });
        }

        function handleEditEvent(id) {
            const event = currentEvents.find(e => e.id === id);
            if (!event) return;
            editingEventId = id;
            renderPage(); // Re-render to show form in edit mode

            // Pre-fill form (need to wait for re-render)
            setTimeout(() => {
                const form = document.getElementById('event-form');
                if (!form) return;
                form.eventName.value = event.eventName || '';
                form.eventPoc.value = event.eventPoc || '';
                form.selectPoc.value = event.selectPoc || '';
                form.startDate.value = event.startDate || '';
                form.endDate.value = event.endDate || '';
                form.location.value = event.location || '';
                form.eventLocation.value = event.eventLocation || '';
                form.classification.value = event.classification || '';
                form.sessionType.value = event.sessionType || '';
                form.attendees.value = event.attendees || '';
                form.selectResources.value = event.selectResources || '';
                form.sessionDays.value = event.sessionDays || '';
                form.sessionSupportDuration.value = event.sessionSupportDuration || '';
                form.additionalNotes.value = event.additionalNotes || '';

                if (event.demo) {
                    const demoArr = Array.isArray(event.demo) ? event.demo : [event.demo];
                    demoArr.forEach(val => {
                        const cb = form.querySelector(`input[name="demo"][value="${val}"]`);
                        if (cb) cb.checked = true;
                    });
                }
            }, 0);
        }

        async function handleEventSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const data = {
                eventName: form.eventName.value,
                eventPoc: form.eventPoc.value,
                selectPoc: form.selectPoc.value,
                startDate: form.startDate.value,
                endDate: form.endDate.value,
                location: form.location.value,
                eventLocation: form.eventLocation.value,
                classification: form.classification.value,
                sessionType: form.sessionType.value,
                attendees: form.attendees.value,
                demo: Array.from(form.querySelectorAll('input[name="demo"]:checked')).map(cb => cb.value),
                selectResources: form.selectResources.value,
                sessionDays: form.sessionDays.value,
                sessionSupportDuration: form.sessionSupportDuration.value,
                additionalNotes: form.additionalNotes.value, // Added new field
                timestamp: new Date().toISOString()
            };

            try {
                if (editingEventId) {
                    await updateDoc(doc(db, 'shared_events', editingEventId), data);
                    showMessage('Event updated successfully!');
                    editingEventId = null;
                } else {
                    await addDoc(collection(db, 'shared_events'), data);
                    showMessage('Event added successfully!');
                }
                // Form reset happens via re-render or manual clear, but renderPage does it cleanest for mode switch
                renderPage();
            } catch (error) {
                showMessage(`Failed to save event: ${error.message}`, true);
            }
        }

        async function handleAnalyzePDF() {
            // ... (Existing PDF logic remains the same) ...
             const btn = document.getElementById('analyze-pdf-btn');
            const btnText = document.getElementById('analyze-btn-text');
            const pdfText = document.getElementById('pdf-text-input').value;
            if (!pdfText.trim()) return;

            btn.disabled = true;
            btnText.textContent = 'Extracting...';
            btn.firstElementChild.classList.add('fa-spin');

            const prompt = `TASK: From the provided BEO text, output only events that satisfy both filters... (truncated for brevity, same prompt as before) ... Text to analyze: ${pdfText}`;
            
            const resultText = await fetchGemini(prompt, false);

            if (resultText && !resultText.startsWith('AI Error')) {
                createModal("Extracted BEO Data for ServiceNow", `
                    <textarea readonly class="w-full h-64 p-4 rounded-lg border-2 bg-gray-50 font-mono text-sm">${resultText}</textarea>
                    <div class="flex justify-end gap-2 mt-4">
                         <button id="copy-modal-btn" class="bg-[#A3E635] text-gray-900 font-bold py-2 px-4 rounded-lg hover:bg-[#8CD02F]">Copy to Clipboard</button>
                    </div>
                `);
                document.getElementById('copy-modal-btn').onclick = () => {
                    navigator.clipboard.writeText(resultText);
                    showMessage('Copied to clipboard!');
                };
            } else {
                showMessage('AI extraction failed.', true);
            }
            btn.disabled = false;
            btnText.textContent = 'Extract Data with AI';
            btn.firstElementChild.classList.remove('fa-spin');
        }

        async function handleGenerateEventSummary() {
            if (currentEvents.length === 0) {
                showMessage('No events to summarize.', true);
                return;
            }
            const btn = document.getElementById('generate-summary-btn');
            const btnText = document.getElementById('summary-btn-text');
            const outputDiv = document.getElementById('summary-output');

            btn.disabled = true;
            btnText.textContent = 'Generating...';

            // Updated to include Additional Notes in the summary prompt
            const eventList = currentEvents.map(e => `
                Event: ${e.eventName}
                Date: ${e.startDate}
                POC: ${e.eventPoc}
                Notes: ${e.additionalNotes || 'None'}
            `).join('\n---\n');

            const prompt = `Provide a concise, professional summary for a team meeting based on these events. Pay attention to any specific "Notes" provided for context: ${eventList}`;
            const summary = await fetchGemini(prompt);
            
            if (summary && !summary.startsWith('AI Error')) {
                outputDiv.textContent = summary;
                outputDiv.classList.remove('hidden');
            } else {
                showMessage('Failed to generate summary.', true);
            }
            btn.disabled = false;
            btnText.textContent = 'AI Summary';
        }
        
        function handleExtractForServiceNow(eventId) {
             const event = currentEvents.find(e => e.id === eventId);
            if (!event) return;
            const output = `Event Name: ${event.eventName || ''}
Start Date: ${event.startDate || ''}
End Date: ${event.endDate || ''}
Event POC: ${event.eventPoc || ''}
SELECT POC: ${event.selectPoc || ''}
Location: ${event.location || 'NYIH'}
Event Location: ${event.eventLocation || ''}
Classification: ${event.classification || ''}
Session Type: ${event.sessionType || ''}
Attendees: ${event.attendees || ''}
Demo: ${(event.demo || []).join('; ')}
SELECT Resources: ${event.selectResources || ''}
Session Days: ${event.sessionDays || ''}
Session Support Duration: ${event.sessionSupportDuration || ''}`;

            createModal("ServiceNow Data", `
                <textarea readonly class="w-full h-64 p-4 rounded-lg border-2 bg-gray-50 font-mono text-sm">${output}</textarea>
                <div class="flex justify-end gap-2 mt-4">
                     <button id="copy-modal-btn" class="bg-[#A3E635] text-gray-900 font-bold py-2 px-4 rounded-lg hover:bg-[#8CD02F]">Copy</button>
                </div>
            `);
            document.getElementById('copy-modal-btn').onclick = () => {
                navigator.clipboard.writeText(output);
                showMessage('Copied to clipboard!');
            };
        }
        
        // --- KANBAN PAGE ---
        function renderKanbanPage() {
             return `
                <div class="bg-white p-6 rounded-2xl shadow-xl">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-center text-[#424A9F] mb-4 md:mb-0">Project Task Board</h2>
                        <button id="ai-kanban-summary-btn" class="bg-[#A3E635] text-gray-900 font-bold py-2 px-4 rounded-lg hover:bg-[#8CD02F] flex items-center justify-center">
                            ${getIcon('zap')} <span id="ai-kanban-summary-text">Generate AI Project Summary</span>
                        </button>
                    </div>
                    <form id="add-task-form" class="space-y-4 max-w-lg mx-auto mb-6">
                        <h3 class="text-lg font-semibold text-gray-700">${editingTaskId ? 'Edit Task' : 'Add New Task'}</h3>
                        <input type="text" name="newTaskText" placeholder="Task Title*" required class="w-full p-2 rounded-lg border-2 border-gray-300 focus:outline-none focus:ring-2 focus:ring-[#A3E635]">
                        <input type="text" name="assignedTo" placeholder="Assigned To" class="w-full p-2 rounded-lg border-2 border-gray-300 focus:outline-none focus:ring-2 focus:ring-[#A3E635]">
                        <textarea name="taskDescription" placeholder="Task Description (Optional)" rows="2" class="w-full p-2 rounded-lg border-2 border-gray-300 focus:outline-none focus:ring-2 focus:ring-[#A3E635]"></textarea>
                        <button type="submit" class="w-full bg-[#424A9F] text-white font-bold py-2 px-4 rounded-lg hover:bg-[#343D84]">${getIcon('plus')} ${editingTaskId ? 'Update Task' : 'Add Task'}</button>
                        ${editingTaskId ? `<button type="button" id="cancel-edit-task-btn" class="w-full bg-gray-300 text-gray-800 font-bold py-2 rounded-lg hover:bg-gray-400">Cancel Edit</button>` : ''}
                    </form>
                    <div class="grid md:grid-cols-3 gap-6">
                        ${renderKanbanColumn('todo', 'To Do')}
                        ${renderKanbanColumn('doing', 'In Progress')}
                        ${renderKanbanColumn('complete', 'Done')}
                    </div>
                </div>`;
        }
        function renderKanbanColumn(status, title) {
            const tasksInColumn = currentTasks.filter(t => t.status === status);
            return `
                <div id="kanban-col-${status}" data-status="${status}" class="kanban-column bg-gray-100 p-4 rounded-xl shadow-inner flex flex-col w-full">
                    <h3 class="text-xl font-bold mb-4 text-center text-[#424A9F]">${title} (${tasksInColumn.length})</h3>
                    <div class="flex-grow space-y-3">
                        ${tasksInColumn.map(task => `
                            <div id="task-${task.id}" class="kanban-card bg-white p-3 rounded-xl shadow-md border-l-4 border-purple-500" draggable="true" data-task-id="${task.id}">
                                <div class="flex justify-between items-start">
                                    <p class="text-gray-900 font-semibold">${task.title}</p>
                                    <div class="flex gap-1">
                                        <button data-id="${task.id}" class="edit-task-btn text-gray-400 hover:text-blue-500 p-1" title="Edit">${getIcon('edit', 'w-3 h-3 m-0')}</button>
                                        <button data-id="${task.id}" class="delete-task-btn text-gray-400 hover:text-red-500 p-1" title="Delete">${getIcon('trash', 'w-3 h-3 m-0')}</button>
                                    </div>
                                </div>
                                ${task.description ? `<p class="text-sm text-gray-600 mt-1">${task.description}</p>` : ''}
                                ${task.assignedTo ? `<p class="text-xs text-gray-500 mt-2 pt-2 border-t">Assigned to: <strong>${task.assignedTo}</strong></p>` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function attachKanbanListeners() {
            document.getElementById('add-task-form').addEventListener('submit', handleAddTask);
            document.getElementById('ai-kanban-summary-btn').addEventListener('click', handleGenerateKanbanSummary);
            document.querySelectorAll('.delete-task-btn').forEach(btn => btn.addEventListener('click', e => {
                e.stopPropagation();
                handleDelete('tasks', e.currentTarget.dataset.id);
            }));
            document.querySelectorAll('.edit-task-btn').forEach(btn => btn.addEventListener('click', e => {
                e.stopPropagation();
                handleEditTask(e.currentTarget.dataset.id);
            }));

            const cancelBtn = document.getElementById('cancel-edit-task-btn');
            if(cancelBtn) cancelBtn.addEventListener('click', () => {
                editingTaskId = null;
                renderPage();
            });

            // ... (Drag and Drop listeners remain the same) ...
            const cards = document.querySelectorAll('.kanban-card');
            const columns = document.querySelectorAll('.kanban-column');
            
            cards.forEach(card => {
                card.addEventListener('dragstart', () => {
                    card.classList.add('dragging');
                });
                card.addEventListener('dragend', () => {
                    card.classList.remove('dragging');
                });
            });

            columns.forEach(column => {
                column.addEventListener('dragover', e => {
                    e.preventDefault();
                    const draggingCard = document.querySelector('.dragging');
                    if (draggingCard) {
                        column.classList.add('drag-over');
                    }
                });
                column.addEventListener('dragleave', () => {
                    column.classList.remove('drag-over');
                });
                column.addEventListener('drop', async e => {
                    e.preventDefault();
                    column.classList.remove('drag-over');
                    const draggingCard = document.querySelector('.dragging');
                    if (draggingCard) {
                        const taskId = draggingCard.dataset.taskId;
                        const newStatus = column.dataset.status;
                        await updateDoc(doc(db, 'shared_tasks', taskId), { status: newStatus });
                        showMessage('Task moved!');
                    }
                });
            });
        }

        function handleEditTask(id) {
            const task = currentTasks.find(t => t.id === id);
            if (!task) return;
            editingTaskId = id;
            renderPage(); // Re-render to switch form mode

            setTimeout(() => {
                const form = document.getElementById('add-task-form');
                if (!form) return;
                form.newTaskText.value = task.title || '';
                form.assignedTo.value = task.assignedTo || '';
                form.taskDescription.value = task.description || '';
            }, 0);
        }

        async function handleGenerateKanbanSummary() {
            const btn = document.getElementById('ai-kanban-summary-btn');
            const btnText = document.getElementById('ai-kanban-summary-text');
            btn.disabled = true;
            btnText.textContent = 'Generating...';

            const todo = currentTasks.filter(t=>t.status==='todo').map(t=>t.title).join(', ') || 'None';
            const doing = currentTasks.filter(t=>t.status==='doing').map(t=>t.title).join(', ') || 'None';
            const complete = currentTasks.filter(t=>t.status==='complete').map(t=>t.title).join(', ') || 'None';
            
            // Updated Prompt for brevity
            const prompt = `Provide a very concise, bulleted executive summary of the project status based on these tasks. Focus on high-level progress and avoid listing every single task in detail.
            
            To Do: ${todo}
            In Progress: ${doing}
            Completed: ${complete}`;

            const summary = await fetchGemini(prompt);
            
            if (summary && !summary.startsWith('AI Error')) {
                 createModal("AI Project Summary", `<p class="whitespace-pre-wrap">${summary}</p>`);
            } else {
                showMessage('Failed to generate summary.', true);
            }
            btn.disabled = false;
            btnText.textContent = 'Generate AI Project Summary';
        }
        async function handleAddTask(e) {
             e.preventDefault();
            const form = e.target;
            const data = {
                title: form.newTaskText.value.trim(),
                assignedTo: form.assignedTo.value.trim(),
                description: form.taskDescription.value.trim(),
                status: 'todo', // Default status for new. For edit, we might want to keep status, but this simple edit assumes resetting flow or we could look up existing.
                // Actually, for edit, we should preserve status if possible, or just update title/desc.
                timestamp: new Date().toISOString()
            };
            
            if (!data.title) return;
            
            try {
                if (editingTaskId) {
                    // Preserve status on edit
                    const existingTask = currentTasks.find(t => t.id === editingTaskId);
                    if (existingTask) data.status = existingTask.status;
                    
                    await updateDoc(doc(db, 'shared_tasks', editingTaskId), data);
                    showMessage('Task updated!');
                    editingTaskId = null;
                } else {
                    await addDoc(collection(db, 'shared_tasks'), data);
                    showMessage('Task added!');
                }
                form.reset();
                renderPage();
            } catch(error) {
                showMessage(`Failed to save task: ${error.message}`, true);
            }
        }

        // --- ISSUES PAGE ---
        function renderIssuesPage() {
            // ... (Issues page remains the same) ...
             return `
            <div class="bg-white p-6 rounded-2xl shadow-xl grid md:grid-cols-2 gap-8">
                <div>
                    <h2 class="text-2xl font-bold text-red-600 mb-4 flex items-center">${getIcon('xcircle')} Log New Tech Issue</h2>
                    <form id="add-issue-form" class="space-y-4">
                        <input name="issueTitle" placeholder="Issue Title*" required class="w-full p-2 rounded-lg border-2 border-gray-300">
                        <textarea name="issueDescription" placeholder="Description*" required rows="3" class="w-full p-2 rounded-lg border-2 border-gray-300"></textarea>
                        <select name="urgency" class="w-full p-2 rounded-lg border-2 border-gray-300 bg-white">
                            <option value="Low">Low Urgency</option>
                            <option value="Medium" selected>Medium Urgency</option>
                            <option value="High">High Urgency</option>
                            <option value="Urgent">Urgent</option>
                        </select>
                        <button type="submit" class="w-full bg-red-600 text-white font-bold py-2 rounded-lg hover:bg-red-700">Log Issue</button>
                    </form>
                </div>
                <div>
                    <h2 class="text-2xl font-bold text-red-600 mb-4">Active Issues (${currentIssues.length})</h2>
                    <div class="space-y-3 max-h-[60vh] overflow-y-auto p-2 border rounded-xl bg-gray-50">
                        ${currentIssues.length > 0 ? currentIssues.map(issue => `
                            <div class="bg-white p-4 rounded-xl shadow-md border-l-4 ${issue.urgency === 'Urgent' ? 'border-red-600' : 'border-yellow-500'}">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-semibold">${issue.issueTitle}</h3>
                                    <div>
                                        <button data-id="${issue.id}" class="ai-diagnose-btn text-gray-400 hover:text-[#424A9F] p-1">${getIcon('zap', 'w-4 h-4 m-0')}</button>
                                        <button data-id="${issue.id}" class="delete-issue-btn text-gray-400 hover:text-red-500 p-1">${getIcon('trash', 'w-4 h-4 m-0')}</button>
                                    </div>
                                </div>
                                <p class="text-sm text-gray-600 mt-1">${issue.issueDescription}</p>
                                <span class="text-xs font-medium bg-gray-200 px-2 py-1 rounded-full mt-2 inline-block">${issue.urgency}</span>
                            </div>`).join('') : '<p class="text-center text-gray-500 p-8">No active issues.</p>'}
                    </div>
                </div>
            </div>`;
        }
        // ... (Rest of the code remains the same) ...
        function attachIssuesListeners() {
            document.getElementById('add-issue-form').addEventListener('submit', handleAddIssue);
            document.querySelectorAll('.delete-issue-btn').forEach(btn => btn.addEventListener('click', e => handleDelete('issues', e.currentTarget.dataset.id)));
            document.querySelectorAll('.ai-diagnose-btn').forEach(btn => btn.addEventListener('click', e => handleAIDiagnosis(e.currentTarget.dataset.id)));
        }
        async function handleAIDiagnosis(issueId) {
            const issue = currentIssues.find(i => i.id === issueId);
            if (!issue) return;
            const prompt = `For a tech issue titled "${issue.issueTitle}" with description "${issue.issueDescription}", provide 3 concise, actionable troubleshooting steps a tech support person could take.`;
            const diagnosis = await fetchGemini(prompt);
            if (diagnosis && !diagnosis.startsWith('AI Error')) {
                createModal(`AI Diagnosis for: ${issue.issueTitle}`, `<p class="whitespace-pre-wrap">${diagnosis}</p>`);
            } else {
                showMessage('AI Diagnosis failed.', true);
            }
        }
        async function handleAddIssue(e) {
            e.preventDefault();
            const form = e.target;
            const data = {
                issueTitle: form.issueTitle.value,
                issueDescription: form.issueDescription.value,
                urgency: form.urgency.value,
                timestamp: new Date().toISOString()
            };
            try {
                await addDoc(collection(db, 'shared_issues'), data);
                showMessage('Issue logged successfully!');
                form.reset();
            } catch (error) {
                showMessage(`Failed to log issue: ${error.message}`, true);
            }
        }

        // --- GENERAL CRUD & MODALS ---
        async function handleDelete(collectionName, id) {
            if (!confirm(`Are you sure you want to delete this ${collectionName.slice(0, -1)}?`)) return;
            try {
                let docRef = doc(db, `shared_${collectionName}`, id);
                await deleteDoc(docRef);
                showMessage(`${collectionName.slice(0, -1)} deleted successfully!`);
            } catch (error) {
                showMessage(`Failed to delete: ${error.message}`, true);
            }
        }
        function createModal(title, content) {
            const modalContainer = document.getElementById('modal-container');
            modalContainer.innerHTML = `
                <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-lg w-full">
                        <h3 class="text-xl font-bold text-[#424A9F] mb-4">${title}</h3>
                        <div class="text-gray-700">${content}</div>
                        <div class="flex justify-end mt-4">
                            <button id="close-modal-btn" class="bg-gray-300 font-bold py-2 px-4 rounded-lg hover:bg-gray-400">Close</button>
                        </div>
                    </div>
                </div>`;
            document.getElementById('close-modal-btn').onclick = () => modalContainer.innerHTML = '';
            document.getElementById('modal-backdrop').onclick = (e) => {
                if(e.target.id === 'modal-backdrop') modalContainer.innerHTML = '';
            };
        }

        // --- APP INITIALIZATION ---
        window.onload = () => {
            setupAuthListeners();
            // onAuthStateChanged will handle the initial render
        };
    </script>
</body>
</html>
