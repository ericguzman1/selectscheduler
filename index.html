<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accenture Project Hub</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: sans-serif; background-color: #f7f7f7; color: #333; }
        /* Custom colors matching your theme */
        .bg-\[\#424A9F\] { background-color: #424A9F; }
        .text-\[\#424A9F\] { color: #424A9F; }
        .hover\:bg-\[\#343D84\]:hover { background-color: #343D84; }
        .bg-\[\#A3E635\] { background-color: #A3E635; }
        .hover\:bg-\[\#8CD02F\]:hover { background-color: #8CD02F; }
        .kanban-column { min-height: 250px; max-height: 600px; overflow-y: auto; }
        .border-red-600 { border-left-color: #dc2626; }
        .border-yellow-500 { border-left-color: #f59e0b; }
        .space-y-4 > * + * { margin-top: 1rem; }
    </style>
</head>
<body>

    <div id="app-container" class="min-h-screen p-4 flex flex-col items-center font-sans">
        <!-- Header and Navigation -->
        <div class="w-full max-w-5xl bg-white p-6 rounded-2xl shadow-xl mb-6">
            <h1 class="text-4xl font-extrabold text-center text-[#424A9F] mb-2">
                Accenture Project Hub
            </h1>
            <p class="text-center text-gray-600 mb-4">
                Welcome to your team's central command center.
            </p>
            <div class="flex justify-center mb-4 space-x-2">
                <button id="nav-schedule" data-page="schedule" class="nav-button px-4 py-2 rounded-lg font-semibold bg-[#A3E635] text-gray-900 shadow-lg">Meetings & Events</button>
                <button id="nav-kanban" data-page="kanban" class="nav-button px-4 py-2 rounded-lg font-semibold bg-gray-200 text-gray-700 hover:bg-gray-300">Task Board</button>
                <button id="nav-issues" data-page="issues" class="nav-button px-4 py-2 rounded-lg font-semibold bg-gray-200 text-gray-700 hover:bg-gray-300">Tech Issues</button>
            </div>
        </div>

        <!-- Message Area -->
        <div id="message-area" class="w-full max-w-5xl hidden bg-blue-100 border-l-4 border-[#A3E635] text-blue-700 p-4 mb-4 rounded-lg shadow-md" role="alert">
            <p id="message-text"></p>
        </div>

        <!-- Dynamic Content Area -->
        <div id="content-area" class="w-full max-w-5xl flex-grow">
            <!-- Content will be rendered here by JavaScript -->
        </div>
    </div>

    <!-- Application Logic -->
    <script type="module">
        // FIX: Import ONLY the module versions of Firebase SDK (v9 syntax)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, collection, onSnapshot, query, where, getDocs, writeBatch, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // Import the functions you need from the SDKs you need
        import { initializeApp } from "firebase/app";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries

        // Your web app's Firebase configuration
        const firebaseConfig = {
        apiKey: "AIzaSyCBuOzD3V96thT2TIiC3n8DdvpfChGYjEo",
        authDomain: "schedule-fef69.firebaseapp.com",
        projectId: "schedule-fef69",
        storageBucket: "schedule-fef69.firebasestorage.app",
        messagingSenderId: "565438351947",
        appId: "1:565438351947:web:b787c417351d16a19cdbce"
        };

// Initialize Firebase
const app = initializeApp(firebaseConfig);

        const GEMINI_API_KEY = "AIzaSyCBuOzD3V96thT2TIiC3n8DdvpfChGYjEo"; // Replace with your Google AI Studio API Key

        // --- INITIALIZE FIREBASE ---
        // FIX: Added check to prevent initializeApp error if config is placeholder/invalid
        let app, db, auth;
        if (FIREBASE_CONFIG.apiKey && FIREBASE_CONFIG.apiKey !== "AIzaSyCBuOzD3V96thT2TIiC3n8DdvpfChGYjEo") {
             app = initializeApp(FIREBASE_CONFIG);
             db = getFirestore(app);
             auth = getAuth(app);
        }
        
        let userId = null;
        let currentEvents = [];
        let currentTasks = [];
        let currentIssues = [];
        let currentPage = 'schedule';

        // --- UI UTILITIES ---

        function showMessage(msg) {
            const msgArea = document.getElementById('message-area');
            const msgText = document.getElementById('message-text');
            msgText.textContent = msg;
            msgArea.classList.remove('hidden');
            setTimeout(() => {
                msgArea.classList.add('hidden');
            }, 5000);
        }

        function handleNavigate(pageName) {
            currentPage = pageName;
            document.querySelectorAll('.nav-button').forEach(btn => {
                const isActive = btn.dataset.page === pageName;
                btn.classList.toggle('bg-[#A3E635]', isActive);
                btn.classList.toggle('text-gray-900', isActive);
                btn.classList.toggle('shadow-lg', isActive);
                btn.classList.toggle('bg-gray-200', !isActive);
                btn.classList.toggle('text-gray-700', !isActive);
            });
            renderPage();
        }

        // Helper for icons (since we can't use React components)
        function getIcon(name, classes = 'w-4 h-4 inline mr-2') {
            const icons = {
                calendar: `<i class="fas fa-calendar-alt ${classes}"></i>`,
                zap: `<i class="fas fa-bolt ${classes}"></i>`,
                trash: `<i class="fas fa-trash-alt ${classes}"></i>`,
                book: `<i class="fas fa-book-open ${classes}"></i>`,
                export: `<i class="fas fa-file-export ${classes}"></i>`,
                exclamation: `<i class="fas fa-exclamation-circle ${classes}"></i>`,
            };
            return icons[name] || '';
        }


        // --- GEMINI AI UTILITY ---
        async function fetchGemini(prompt, isJson = false) {
            if (!GEMINI_API_KEY || GEMINI_API_KEY === "AIzaSyCBuOzD3V96thT2TIiC3n8DdvpfChGYjEo") {
                showMessage("AI Error: Gemini API Key is missing or invalid. Please update the script.");
                return isJson ? {} : "AI Key Missing.";
            }

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: isJson ? {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            eventName: { type: "STRING" },
                            startDate: { type: "STRING" },
                            endDate: { type: "STRING" },
                            eventPOC: { type: "STRING" },
                            selectPOC: { type: "STRING" },
                            location: { type: "STRING" },
                            eventLocation: { type: "STRING" },
                            classification: { type: "STRING" },
                            sessionType: { type: "STRING" },
                            attendees: { type: "STRING" },
                            demo: { type: "STRING" },
                            selectResources: { type: "STRING" },
                        },
                    },
                } : {}
            };

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                
                if (!response.ok || result.error) {
                    throw new Error(result.error?.message || `HTTP ${response.status} failed.`);
                }

                const generatedText = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                
                return isJson ? JSON.parse(generatedText || '{}') : generatedText;
            } catch (error) {
                console.error("Gemini API Error:", error);
                return isJson ? {} : `AI Error: ${error.message}`;
            }
        }
        
        // --- DATA LISTENERS ---

        function setupDataListeners() {
            if (!userId) return;

            // Events Listener
            const eventsCollectionRef = collection(db, `users/${userId}/events`);
            onSnapshot(eventsCollectionRef, (snapshot) => {
                currentEvents = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                })).sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
                renderPage();
            });

            // Tasks Listener
            const tasksCollectionRef = collection(db, `users/${userId}/tasks`);
            onSnapshot(tasksCollectionRef, (snapshot) => {
                currentTasks = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                }));
                renderPage();
            });

            // Issues Listener
            const issuesCollectionRef = collection(db, `users/${userId}/issues`);
            onSnapshot(issuesCollectionRef, (snapshot) => {
                currentIssues = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                })).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                renderPage();
            });
        }
        
        // --- EVENT HANDLERS (Simplified CRUD handlers for Firestore) ---

        async function handleEventSubmit(e) {
            e.preventDefault();
            if (!db) { showMessage("Error: Database not initialized."); return; }

            const form = e.target;
            const data = {
                eventName: form.eventName.value,
                eventPOC: form.eventPOC.value,
                startDate: form.startDate.value,
                endDate: form.endDate.value,
                classification: form.classification ? form.classification.value : 'Unclassified',
                location: form.location ? form.location.value : 'NYIH',
                eventLocation: form.eventLocation ? form.eventLocation.value : '',
                attendees: form.attendees ? form.attendees.value : '',
                demoResources: Array.from(form.querySelectorAll('input[name="demoResources"]:checked')).map(cb => cb.value),
                timestamp: new Date().toISOString()
            };

            try {
                const eventsCollectionRef = collection(db, `users/${userId}/events`);
                await addDoc(eventsCollectionRef, data);
                form.reset();
                showMessage('Event added successfully!');
            } catch (error) {
                console.error('Firestore Save Error:', error);
                showMessage(`Failed to add event: ${error.message}`);
            }
        }
        
        async function handleDeleteData(id, collectionName) {
            if (!db) { showMessage("Error: Database not initialized."); return; }
            try {
                const docRef = doc(db, `users/${userId}/${collectionName}`, id);
                await deleteDoc(docRef);
                showMessage(`${collectionName.slice(0, -1)} deleted successfully!`);
            } catch (error) {
                console.error(`Error deleting ${collectionName}: `, error);
                showMessage(`Failed to delete ${collectionName.slice(0, -1)}.`);
            }
        }

        async function handleGenerateSummary() {
             showMessage('Generating summary with AI...');

            const eventList = currentEvents.map(e => (
                `Event Name: ${e.eventName}, Date: ${e.startDate}, Location: ${e.eventLocation || e.location}, POC: ${e.eventPOC}`
            )).join('; ');

            const prompt = `Provide a concise and professional summary of the team's upcoming events. Events: ${eventList || 'None'}`;
            const generatedText = await fetchGemini(prompt, false);
            
            if (generatedText && !generatedText.startsWith('AI Error')) {
                document.getElementById('summary-output-text').textContent = generatedText;
                document.getElementById('summary-output').classList.remove('hidden');
                showMessage('Summary generated successfully!');
            } else {
                showMessage(`AI Summary failed: ${generatedText}`);
            }
        }
        
        async function handleAnalyzePDF() {
            const pdfText = document.getElementById('pdfText').value;
            if (!pdfText.trim()) return;
            showMessage('Analyzing text with AI...');

            const extractedData = await fetchGemini(pdfText, true);
            
            if (extractedData) {
                const form = document.getElementById('event-form');
                form.eventName.value = extractedData.eventName || '';
                form.startDate.value = extractedData.startDate || '';
                form.endDate.value = extractedData.endDate || '';
                showMessage('Data extracted successfully! Review and save.');
            } else {
                showMessage('AI extraction failed.');
            }
        }
        
        // --- PAGE RENDERING ---

        function renderPage() {
            const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = ''; // Clear existing content

            if (currentPage === 'schedule') {
                contentArea.innerHTML = renderSchedulePage();
                
                // FIX: Must RE-ATTACH all event listeners after innerHTML update
                document.getElementById('event-form').onsubmit = handleEventSubmit;
                document.getElementById('analyze-pdf').onclick = handleAnalyzePDF;
                document.getElementById('generate-summary').onclick = handleGenerateSummary;

                document.querySelectorAll('.delete-event-btn').forEach(btn => {
                    btn.onclick = (e) => handleDeleteData(e.currentTarget.dataset.id, 'events');
                });
            } else if (currentPage === 'kanban') {
                contentArea.innerHTML = renderKanbanPage();
                // Attach Kanban listeners
            } else if (currentPage === 'issues') {
                 contentArea.innerHTML = renderIssuesPage();
                 // Attach Issues listeners
                 document.querySelectorAll('.delete-issue-btn').forEach(btn => {
                    btn.onclick = (e) => handleDeleteData(e.currentTarget.dataset.id, 'issues');
                 });
            }
        }
        
        // --- HTML TEMPLATES ---

        function renderSchedulePage() {
            const resourceCheckboxes = ["Surface Hubs", "Proto", "Spot", "Hypervsn", "GenAI", "Vestaboard", "Loaner Laptop", "Clicker", "Teams Call", "Vu AI", "Other"].map(r => `
                <label class="flex items-center space-x-2 text-sm text-gray-700">
                    <input type="checkbox" name="demoResources" value="${r}" class="text-[#424A9F] focus:ring-[#A3E635]">
                    <span>${r}</span>
                </label>`).join('');

            const eventListItems = currentEvents.map(event => `
                <div class="bg-gray-50 p-4 rounded-xl shadow-md flex justify-between items-start border-l-4 border-[#424A9F]">
                    <div>
                        <h3 class="text-lg font-semibold">${event.eventName}</h3>
                        <p class="text-sm">Date: ${event.startDate} to ${event.endDate}</p>
                        <p class="text-sm">POC: ${event.eventPOC}</p>
                    </div>
                    <div class="flex flex-col gap-2">
                        <button data-event-id="${event.id}" class="export-event-btn bg-[#A3E635] text-gray-900 px-3 py-1 rounded-lg text-xs font-bold hover:bg-[#8CD02F]"><i class="fas fa-file-export mr-1"></i> Export</button>
                        <button data-id="${event.id}" class="delete-event-btn bg-red-500 text-white px-3 py-1 rounded-lg text-xs font-bold hover:bg-red-600"><i class="fas fa-trash-alt mr-1"></i> Delete</button>
                    </div>
                </div>
            `).join('');

            return `
                <div class="bg-white p-6 rounded-2xl shadow-xl grid md:grid-cols-2 gap-8">
                    <div>
                        <h2 class="text-2xl font-bold text-[#424A9F] mb-4">Add Event & AI Extraction</h2>
                        <div class="p-4 bg-gray-50 rounded-xl shadow-inner border border-gray-200 mb-4">
                            <label class="block text-sm font-medium mb-1 text-gray-700">Paste Report Text for AI Extraction:</label>
                            <textarea id="pdfText" class="w-full h-32 p-2 rounded-lg border-2 border-gray-300 bg-white text-gray-900 resize-none focus:outline-none focus:ring-2 focus:ring-[#A3E635]" placeholder="Paste your PDF report text here..."></textarea>
                            <button id="analyze-pdf" type="button" class="mt-2 w-full bg-[#A3E635] text-gray-900 font-bold py-2 px-4 rounded-lg hover:bg-[#8CD02F] transition-colors duration-300 flex items-center justify-center">
                                ${getIcon('zap')} Extract Data with AI
                            </button>
                        </div>

                        <form id="event-form" class="space-y-4 p-4 border border-gray-200 rounded-xl">
                            <input type="text" name="eventName" placeholder="Event Name" class="w-full p-2 border rounded" required>
                            <input type="text" name="eventPOC" placeholder="Event POC" class="w-full p-2 border rounded" required>
                            <input type="date" name="startDate" class="w-full p-2 border rounded" required>
                            <input type="date" name="endDate" class="w-full p-2 border rounded" required>
                            <select name="classification" class="w-full p-2 border rounded">
                                <option>Unclassified</option><option>Confidential</option><option>Secret</option>
                            </select>
                            <input type="text" name="location" value="NYIH" placeholder="Location" class="w-full p-2 border rounded">
                            <input type="text" name="eventLocation" placeholder="Room/Event Location" class="w-full p-2 border rounded">
                            <input type="text" name="attendees" placeholder="Attendees (comma-separated)" class="w-full p-2 border rounded">

                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-gray-700">Demo Resources:</label>
                                <div class="grid grid-cols-2 gap-2 bg-gray-100 p-3 rounded-lg">
                                    ${resourceCheckboxes}
                                </div>
                            </div>
                            
                            <button type="submit" class="w-full bg-[#424A9F] text-white font-bold py-3 rounded-lg hover:bg-[#343D84] transition-colors duration-300">
                                ${getIcon('calendar')} Add Event to Schedule
                            </button>
                        </form>
                    </div>
                    
                    <div>
                        <h2 class="text-2xl font-bold text-[#424A9F] mb-4">Upcoming Events (${currentEvents.length})</h2>
                        <button id="generate-summary" class="w-full bg-[#A3E635] text-gray-900 font-bold py-2 px-3 rounded-lg hover:bg-[#8CD02F] transition-colors duration-300 flex items-center justify-center mb-4">
                            ${getIcon('zap')} Generate AI Summary
                        </button>
                        <div id="summary-output" class="bg-gray-100 p-4 rounded-lg shadow-inner whitespace-pre-wrap mb-4 hidden">
                            <h4 class="font-bold text-[#424A9F] mb-2">Summary:</h4>
                            <p id="summary-output-text"></p>
                        </div>

                        <div class="space-y-4 max-h-96 overflow-y-auto p-2 border rounded-xl bg-white">
                            ${eventListItems}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderKanbanPage() {
            return `
                <div class="bg-white p-6 rounded-2xl shadow-xl">
                    <h2 class="text-2xl font-bold text-[#424A9F] mb-4">Project Task Board (${currentTasks.length} Tasks)</h2>
                    <p class="text-gray-600">Task form and Kanban columns go here.</p>
                </div>
            `;
        }
        
        function renderIssuesPage() {
            return `
                <div class="bg-white p-6 rounded-2xl shadow-xl grid md:grid-cols-2 gap-6">
                    <div>
                        <h2 class="text-2xl font-bold text-red-600 mb-4 flex items-center">${getIcon('exclamation')} Log New Tech Issue</h2>
                        <p class="text-gray-600">Issue logging form goes here.</p>
                    </div>
                    
                    <div>
                        <h2 class="text-2xl font-bold text-red-600 mb-4">Active Issues (${currentIssues.length})</h2>
                        <div class="space-y-3 max-h-96 overflow-y-auto p-2 border rounded-xl">
                            ${currentIssues.map(issue => `
                                <div class="bg-gray-50 p-4 rounded-xl shadow-md flex justify-between items-start border-l-4 ${issue.urgency === 'Urgent' ? 'border-red-600' : 'border-yellow-500'}">
                                    <div>
                                        <h3 class="font-semibold">${issue.issueTitle}</h3>
                                        <p class="text-sm text-gray-600">Urgency: ${issue.urgency}</p>
                                    </div>
                                    <button data-id="${issue.id}" class="delete-issue-btn text-red-500 hover:text-red-700">${getIcon('trash')}</button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // --- INITIALIZATION ---

        window.onload = () => {
            // Check if essential config is missing before trying to sign in
            if (!FIREBASE_CONFIG.apiKey || FIREBASE_CONFIG.apiKey === "AIzaSyCBuOzD3V96thT2TIiC3n8DdvpfChGYjEo") {
                 showMessage("CRITICAL: Firebase configuration is missing. Please update the script.");
                 return;
            }

            signInAnonymously(auth).catch(error => {
                console.error("Anonymous sign-in failed:", error);
                showMessage("Authentication failed. Data saving disabled.");
            });
        };

        onAuthStateChanged(auth, user => {
            if (user) {
                userId = user.uid; // Actual user ID from Firebase Auth
            } else {
                userId = 'anonymous_user_id'; // Fallback
            }
            setupDataListeners();
            handleNavigate('schedule'); // Initial page load
        });

        // Set up navigation listeners
        document.querySelectorAll('.nav-button').forEach(btn => {
            btn.onclick = () => handleNavigate(btn.dataset.page);
        });
        
    </script>
</body>
</html>
